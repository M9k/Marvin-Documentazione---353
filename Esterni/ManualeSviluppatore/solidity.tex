\documentclass[ManualeSviluppatore.tex]{subfiles}

\begin{document}

% riferimento: https://www.eclipse.org/sirius/doc/developer/Sirius%20Developer%20Manual.html

\chapter{Solidity}
\section{Architecture}
\subsection{Architecture Overview}
The main contract, University, consisted in a hierarchy of small contracts, each other manage a part of the overall features that must be offered all together.\\
University contract uses two more contracts to define users: Teacher and Student. These two contracts share some functionality, because they are made from specialization of another contract, User, which contains the basic functionality for a user.\\
Administrators don't need a contract, because they don't have to keep trace of a list or complex information, the University only has to keep their addresses.\\
University keeps a list of academic years, represented by the contract "Year", who has a list of courses, represented by the contract "Course", which finally has a list of the exams, represented by "Exam".\\

Is University contract responsibility to stabilize the rules, preventing unauthorized user to do actions not within their competence. This control is also can be done indirectly from contract subsequently instantiated to have more performance and reduce the cost.\\

\subsection{Chebotko Diagram}
\subsubsection{Overview of data structure}
The organization of data in the Blockchain cannot be comparable to a relational database, because it's impossible to recover in a quick way the data and/or make a query on it.\\
The structure of the data can be assimilable, which opportune consideration, to some not relational database, also called NoSQL, "Not Only SQL".\\

A database identified similar to our case is Cassandra, which is distributed with no single point of failure, high availability and guarantees a fast recovery of data only if they are recoverable without join between tables, an operation that is not even supported.\\

\subsubsection{Overview of Chebotko Diagram}
To get a better understanding of the architecture and to get a consistent design a Chetbotko diagram was created.\\
This diagram was designed for CassandraDB, but it can be used, with some shrewdness, to the data saved using maps in the Ethereum contracts.\\
The goal of this diagram is demonstrate which data can be accessible using certain keys.\\
A second goal is demonstrating that all needed data are accessible quickly starting from an information that leads to it and visually check that no data is inaccessible.\\
Every map has two arrows, one that enter from above and one that come out from under: the first one indicate the key that can be used in those maps to get other data, the second one indicates the information that can be recovered from it and used in another map as keys.\\

\begin{landscape}
\newpage
\subsubsection{Chebotko Diagram for Marvin}
\begin{figure}[h]
	\centering
	\includegraphics[width=1\linewidth]{"diagrammi/Chebotko Diagram"}
	\caption{Chebotko diagram for Marvin}
	\label{fig:Chebotko diagram for Marvin}
\end{figure}
\end{landscape}
\newpage

In this diagram, the divisions of responsibilities are still ignored, as it will be the task of the next phase to detect the best subdivision.\\
The current focus is only the understanding of data provision and their connection.\\

A difference compared to the standard Chebotko diagram used on CassandraDB is the presence of containers, highlighted by different colors, which represent multiple instances of the same data schema.\\
An arrow entering a map belonging to a different container must therefore know, in addition to the information to be used a key for the map itself, the address to which that container is positioned, obtainable through other maps of the previous container.\\
The only exception of access is the university container, as the address must be available to access the system itself.\\

\subsection{UML Diagram}

\subsubsection{University contract}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\linewidth]{"diagrammi/solidity/university"}
	\caption{University contract}
	\label{fig:University contract}
\end{figure}
The University contract is decomposed into a hierarchy to guarantee a better manageability, but when it will be placed in the blockchain it will be a single one containing all the aspects. \\
The base contract, University, has the role of maintaining information about the founder and checking if an address already has a role within the contract, thus blocking double accounts. \\
The second one, UniversityAdmin, maintains the list of the administrator and allows its management by the founder. \\
UniversityStuden and UniversityTeacher are responsible for maintaining the list of users and professors and providing access to their contracts. \\
UniversityYear contains the list of years and links with related contracts and UniversityExam offers the method to associate exams with professors. \\
The hierarchy order is not significant, as some contracts can be reversed without causing problems and without compromising the logic. \\

\subsubsection{User contracts}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{"diagrammi/solidity/user"}
	\caption{User contracts}
	\label{fig:User contracts}
\end{figure}
Unlike the university, in this case the hierarchy is used similarly to the object-oriented programming, and not only to compose a larger contract. \\
The User contract offers the basic characteristics of a user, containing his public key to verify his identity, his name and his surname. \\
The Student contract extends the basic contract by adding information about the course and the exams, also providing methods for their manipulation. \\
The Teacher contract, in the same way as the Student contract, extends the basic contract by adding the exam list pertaining to the professor. \\

\subsubsection{Year contract}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{"diagrammi/solidity/year"}
	\caption{Year contract}
	\label{fig:Year contract}
\end{figure}
The Year contract keeps the information of the solar year and contains the related courses. \\

\subsubsection{Course contract}
\begin{figure}[H]
\centering
\includegraphics[width=0.7\linewidth]{"diagrammi/solidity/course"}
\caption{Course contract}
\label{fig:Course contract}
\end{figure}
The Course contract keeps the information about his details and contains the related exams. \\

\subsubsection{Exam contract}
\begin{figure}[H]
\centering
\includegraphics[width=0.7\linewidth]{"diagrammi/solidity/exam"}
\caption{Exam contract}
\label{fig:Exam contract}
\end{figure}
The Exam contract keeps the information about his details, the contract of the assigned professor and the list of student enrolled to him. \\

\newpage
\section{Extend the contracts}

\subsection{Provide custom user type}
New user type can be added simply extending User contract, or directly use it there is no need for extra information. \\

\subsection{Extend the university contract}
To extend the University contract is sufficient to create a new contract that inherits from the last one of the current hierarchy. \\
Once the new contract is added, open "migration" folder in the Marvin root, then open the migration for the university and change the artifacts.require parameter, inserting the name of the new contract. \\
Care must be taken about the size of the overall contract, because it may exceed the gas limit for the Ethereum network, in this case the contract has to be separated into two, deployed together and then linked to each other. \\
The actual gas limit can be checked on \nURI{https://ethstats.net}, in the moment in which this document is being written it is about 8'000'000 gas and the University contract uses just over half of this limit. \\


\end{document}